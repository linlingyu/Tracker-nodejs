var config = require('config');
function clientCode(){
    var _tracker_,
        _trackerStart_,
        _trackerEnd_;
    void function(){
        var conf = $;
        var socket = io.connect('http://' + conf.socketServer.host + ':' + conf.socketServer.port),
            url = location.href.split( "#" )[0],
            title = document.title,
            keyTasks = [],
            tasks = [],
            limit = 2000,
            timer;
            
        socket.on('ready', onReady);
        
        function onReady(data){
            if(!data.ready){return;}
            send();
        }
        
        function send(){
            var data;
            if(keyTasks.length){
                data = (data || []).concat(keyTasks);
                keyTasks = [];
            }
            if(tasks.length){
                data = (data || []).concat(tasks.splice(0, limit));
            }
            data && socket.emit('send', data);
            clearTimeout(timer);
            timer = setTimeout(send, 500);
        }
        
        _tracker_ = function(ident, arrivalId){
            tasks.push({
                type: 'tracker',
                ident: ident,
                arrivalId: arrivalId
            });
        };
        _trackerStart_ = function(ident){
            keyTasks.push({
                type: 'trackerStart',
                ident: ident,
                url: url,
                title: title || (title = document.title),
                time: new Date().getTime()
            });
        };
        _trackerEnd_ = function(ident){
            tasks.push({
                type: 'trackerEnd',
                ident: ident,
                time: new Date().getTime()
            });
        };
    }();
}

exports.getCode = function(){
    var client = clientCode.toString(),
        conf = JSON.stringify(config, null, 4);
    return client.slice(client.indexOf('{') + 1, client.length -2)
        .replace('$', conf);
}