var utility = require('utility/utility'),
    MapList = require('MapList'),
    Referer = require('Referer'),
    Code = require('Code'),
    codeList = new MapList(),
    mapList = new MapList(),
    fnList = new MapList();

function CodeController(){
    
}

utility.defineProperties(CodeController.prototype, {
    assignMsg: function(socketId, data){
        var code, referer;
        data.forEach(function(item){
            code = codeList.get('codeId_' + item.ident);
            if(!code){return;}
            switch(item.type){
                case 'trackerStart':
                    referer = mapList.get(socketId);
                    if(!referer){
                        referer = new Referer(socketId, item);
                        mapList.put(referer.getRefererId(), referer);
                    }
                    referer.addCode(code.getCodeId());
                    code.setReferer(referer);
                    code.setStartTime(item.time);
                    break;
                case 'tracker':
                    code.addArrivalId(item.arrivalId);
                    break;
                case 'trackerEnd':
                    code.setEndTime(item.time);
                    break;
                case 'trackerError':
                    code.setStatus(false);
                    break;
                case 'fnStart':
                case 'fnEnd':
                    var fn = fnList.get(item.fnId),
                        prop = item.type.toLowerCase().substring(2) + 'Time';
                    fn[prop] = item.time;
                    break;
                default: break;
            }
        });
        
    },
    
    buildCode: function(data){
        var code = new Code(data.origContent, data);
        codeList.put(code.getCodeId(), code);
    },
    
    buildFunction: function(data){
        //建立code和fn的关联关系
        var fnStmt = data.opts.fnStmt, code;
        if(fnStmt.length === 0){return;}
        code = codeList.get('codeId_' + fnStmt[0].codeId);
        fnStmt.forEach(function(item){
            item.startTime =
            item.endTime = 0;
            fnList.put(item.fnId, item);
            code.addFn(item.fnId);
        });
    },
    
    
    getMapList: function(){
        return mapList;
    },
    
    getCodeList: function(){
        return codeList;
    },
    
    getFnList: function(){
        return fnList;
    }
});



exports.create = function(){
    return new CodeController();
}