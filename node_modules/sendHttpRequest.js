var http = require('http'),
    querystring = require('querystring'),
    date = require('utility/date').date,
    url = 'http://fe.baidu.com/push/simpleTasks/finish';
function getSummary(refeList){
    if(!refeList){return;}
    var refe = refeList[0],
        ret = [],
        totalLine = 0,
        executeLine = 0;
    refe.codeList.forEach(function(code){
        ret.push({
            codeId: code.codeId,
            name: code.name,
            url: code.url,
            type: code.type,
            executeCount: code.executeCount,
            totalLineNumber: code.totalLineNumber,
            coverRatio: code.coverRatio,
            executeTime: code.coverRatio,
            loadTime: code.loadTime,
            status: code.status
        });
        totalLine += code.totalLineNumber;
        executeLine += code.executeCount;
    });
    return {tracker: ret, coverRatio: Math.round(executeLine / totalLine * 100)};
}
exports.httpRequest = function(data){
    var postData = querystring.stringify({
            id: data.uuid,
            summary: JSON.stringify(getSummary(data.detail)),
            detail: JSON.stringify({tracker: data.detail})
        }),
        taskData = {
            uuid: data.uuid,
            finishTime: date.format(new Date(), 'yyyy-MM-dd hh:mm:ss')
        },
        req = http.request({
            hostname: 'fe.baidu.com',
            port: 80,
            path: '/pagetimeline/db/insertTracker.php',
            method: 'POST',
            headers: {
                "Content-Type": 'application/x-www-form-urlencoded',
                "Content-Length": postData.length
            }
        }, function(res){
            var resData = [];
            console.log('STATUS: ' + res.statusCode + ', URL: insertTracker.php');
            res.setEncoding('utf8');
            res.on('data', function(chunk){
                resData.push(chunk);
            });
            res.on('end', function(){//数据完成，发送请求告诉任务管理器完成操作
                http.get(url + '?' + querystring.stringify(taskData), function(res){
                    console.log('STATUS: ' + res.statusCode + ', URL: ' + url);
                    res.setEncoding('utf8');
                });
            });
        });
    req.write(postData + '\n');
    req.end();
};
