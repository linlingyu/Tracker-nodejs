var config = require('config'),
    util = require('util'),
    utility = require('utility/utility'),
    events = require('events'),
    socketio = require('socket.io');

function SocketServer(){
    events.EventEmitter.call(this);
}
util.inherits(SocketServer, events.EventEmitter);
utility.defineProperties(SocketServer.prototype, {
    start: function(port){
        var me = this,
            socketIo = socketio.listen(port || config.socketServer.port, {
                'log level': 0,
                'browser client minification': true
            });
        //
        socketIo.sockets.on('connection', function(socket){
            socket.emit('ready', {ready: true});//发送一个请求表示已经可以准备接收，连接成功
            
            socket.on('send', function(data){//接收从html页面发来的数据
                me.emit('send', {socket: socket, data: data});
            });
            
            socket.on('pageload', function(args){//接收一个html页面加载完成时的处理
                me.emit('pageload', {socket: socket, taskId: args.taskId});
            });
        });
        return me;
    },
    
    stop: function(){
        
    }
});

exports.create = function(){
    return new SocketServer();
}